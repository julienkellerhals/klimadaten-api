{% extends 'base.html' %}
{% block title %}Tables{% endblock %}

{% block head %}
{{ super() }}
<style>
    .hide {
        display: none;
    }

    #tableContainer {
        display: flex;
        align-items: stretch;
    }

    .schema {
        flex-grow: 1;
    }

    #stage {
        background: red;
    }

    #core {
        background: blue;
    }
</style>
{% endblock %}

{% set active_page = "tables" %}

{% block container %}
<nav>
    <div class="nav-wrapper grey darken-3">
        <div class="row valign-wrapper">
            <div class="col s10">
                <a href="/admin/tables" id="dbConnection" class="breadcrumb grey-text">Connect to database</a>
                <a href="/admin/tables" id="dbCreate" class="breadcrumb grey-text">Create database</a>
                <a href="/admin/tables" class="breadcrumb grey-text">Create tables</a>
            </div>
            <div class="col s2">
                <a id="dbAction" class="waves-effect waves-light btn-small right">Action</a>
            </div>
        </div>
        <script>
            var currentStatus = null

            function execCurrentAction() {
                if (currentStatus == null) {
                    startEngine()
                } else if (currentStatus == "dbConnection") {
                    createDb()
                }
            }

            function startEngine() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/db/connect", true);
                xhr.send()
                getEngineStatus()
            }

            function streamEngineStatus() {
                var engineEventSource = new EventSource("/admin/stream/getEngineStatus");
                var previousStatusCode = null
                engineEventSource.onmessage = function (e) {
                    var content = e.data
                    var statusCode = parseInt(content.split(";")[0].split(":")[1]);
                    var dbConnection = document.getElementById("dbConnection")
                    if (previousStatusCode != statusCode) {
                        previousStatusCode = statusCode
                        if (statusCode == 1) {
                            dbConnection.classList.remove("text-darken-1")
                            dbConnection.classList.add("text-lighten-5")
                            currentStatus = null
                        } else if (statusCode == 0) {
                            dbConnection.classList.remove("text-lighten-5")
                            dbConnection.classList.add("text-darken-1")
                            currentStatus = "dbConnection"
                        }
                    }
                };
            }
            function getEngineStatus() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/getEngineStatus", true);
                xhr.send()
            }
            streamEngineStatus();
            setInterval(getEngineStatus, 10000);

            function createDb() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/db/create", true);
                xhr.send()
                getDatabaseStatus()
            }

            function streamDatabaseStatus() {
                var databaseEventSource = new EventSource("/admin/stream/getDatabaseStatus");
                var previousStatusCode = null
                databaseEventSource.onmessage = function (e) {
                    var content = e.data;
                    var statusCode = parseInt(content.split(";")[0].split(":")[1]);
                    var dbCreate = document.getElementById("dbCreate")
                    if (previousStatusCode != statusCode) {
                        previousStatusCode = statusCode
                        if (statusCode == 0) {
                            // msgTxt = "Status: 0; Database connection: " + str(self.databaseUrl)
                            dbCreate.classList.remove("text-lighten-5")
                            dbCreate.classList.add("text-darken-1")
                            if (currentStatus == null) {
                                currentStatus = null
                            } else if (currentStatus == "dbConnection") {
                                currentStatus = "dbCreate"
                            }
                        } else if (statusCode == 1) {
                            // msgTxt = "Status: 1; Database not created; Error: " + str(e)
                            dbCreate.classList.remove("text-darken-1")
                            dbCreate.classList.add("text-lighten-5")
                            if (currentStatus == null) {
                                currentStatus = null
                            } else if (currentStatus == "dbConnection") {
                                currentStatus = "dbConnection"
                            }
                        } else if (statusCode == 2) {
                            // msgTxt = "Status: 2; Database not started; Error: " + str(e)
                            dbCreate.classList.remove("text-darken-1")
                            dbCreate.classList.add("text-lighten-5")
                            if (currentStatus == null) {
                                currentStatus = null
                            } else if (currentStatus == "dbConnection") {
                                currentStatus = "dbConnection"
                            }
                        }
                    }
                };
            }
            function getDatabaseStatus() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/getDatabaseStatus", true);
                xhr.send()
            }
            streamDatabaseStatus();
            setInterval(getDatabaseStatus, 10000);

            document.getElementById("dbAction").addEventListener("click", execCurrentAction)
        </script>
    </div>
</nav>
<div id="container">
    <div class="row">

        <div class="col s6">
            <div id="stage" class="schema">
                <h1>Stage Schema</h1>
                <div class="tableGroup">
                    <div id="tableCreate">create tables</div>
                    <script>
                        function createTables() {
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "/admin/db/table", true);
                            xhr.send()
                        }
                        document.getElementById("tableCreate").addEventListener("click", createTables)
                    </script>
                    <div id="execCoreETL">Run stage to core etl</div>
                    <script>
                        function runCoreETL() {
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "/admin/db/etl/core", true);
                            xhr.send()
                        }
                        document.getElementById("execCoreETL").addEventListener("click", runCoreETL)
                    </script>
                    <div id="execStageETL">Run stage etl</div>
                    <script>
                        function runCoreETL() {
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "/admin/db/etl/stage", true);
                            xhr.send()
                        }
                        document.getElementById("execStageETL").addEventListener("click", runCoreETL)
                    </script>
                </div>
            </div>
        </div>
        <div class="col s6">
            <div id="core" class="schema">
                <h1>Core Schema</h1>
                <div class="tableGroup">
                    <script>

                    </script>
                </div>
            </div>
        </div>

    </div>
</div>
Show database tables
{% endblock %}